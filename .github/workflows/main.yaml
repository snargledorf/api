name: Check and deploy

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

env:
  GITHUB_SHA: ${{ github.sha }}
  GITHUB_ORG: ${{ github.event.organization.name }}
  GITHUB_REPO: ${{ github.event.repository.name }}
  GITHUB_REF: ${{ github.ref }}
  GITHUB_BRANCH: $GITHUB_REF##*/

jobs:
  check:
    name: General code checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Node
        uses: actions/setup-node@v2
        with:
          node-version: lts/*
      - name: Setup pnpm
        uses: pnpm/action-setup@v2.0.1
        with:
          version: 6
      - name: Install dependencies
        run: pnpm install
      - name: Ensure correct formatting
        run: pnpm format:check
      - name: Ensure correct linting
        run: pnpm lint:check
      - name: Ensure tests pass requirements
        run: pnpm test:check
      - name: Ensure code builds
        run: pnpm build:check
  build:
    name: Build container image
    if: github.event_name == 'push'
    needs: check
    runs-on: ubuntu-latest
    env:
      CONTAINER_REGISTRY: ghcr.io
      IMAGE_NAME: $CONTAINER_REGISTRY/$GITHUB_ORG/$GITHUB_REPO
    steps:
      - uses: actions/checkout@v2
      - name: Login to github container registry
        uses: docker/login-action@v1
        with:
          registry: $CONTAINER_REGISTRY
          username: ${{ secrets.CONTAINER_REGISTRY_USER }}
          password: ${{ secrets.CONTAINER_REGISTRY_PASSWORD }}
      - name: Build and push image
        uses: docker/build-push-action@v2
        with:
          push: true
          tags: $IMAGE_NAME:$GITHUB_SHA,$IMAGE_NAME:$GITHUB_BRANCH,$IMAGE_NAME:latest
  deploy:
    name: Deploy to kubernetes
    if: github.event_name == 'push'
    needs: build
    runs-on: ubuntu-latest
    env:
      K8S_CLUSTER_NAME: k8s-bandsy
      K8S_CONFIG_PATH: $GITHUB_WORKSPACE/.kubeconfig
      HELM_RELEASE_NAMESPACE: winget-run-dev
      HELM_RELEASE_NAME: $GITHUB_REPO
      HELM_CHART_DIR: ./chart
    steps:
      - uses: actions/checkout@v2
      - name: Save kubeconfig
        uses: digitalocean/action-doctl@v2
        env:
          DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
        with:
          args: kubernetes cluster kubeconfig show $K8S_CLUSTER_NAME > $K8S_CONFIG_PATH
      - name: Install helm
        run: |-
          curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
          chmod 700 get_helm.sh
          ./get_helm.sh
      - name: Update deployment
        run: helm upgrade $HELM_RELEASE_NAME $HELM_CHART_DIR --install --atomic --namespace $HELM_RELEASE_NAMESPACE --kubeconfig=$K8S_CONFIG_PATH --set-string sha=$GITHUB_SHA
